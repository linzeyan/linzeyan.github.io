services:
  # -----------------------------------------
  # Docker Registry UIï¼ˆå‰ç«¯å¯è¦–åŒ–ç®¡ç†ä»‹é¢ï¼‰
  # -----------------------------------------
  registry-ui:
    image: joxit/docker-registry-ui:main # å®˜æ–¹ UI æ˜ åƒï¼ˆå»ºè­°æŒ‡å®š tagï¼Œä¾‹å¦‚: 2.5.3ï¼‰
    container_name: registry-ui
    restart: always
    network_mode: host
    environment:
      # æŒ‡å®šå–®ä¸€ Registry æ¨¡å¼ï¼ˆtrue è¡¨ç¤ºåªé€£åˆ°ä¸€å€‹å¾Œç«¯ registryï¼‰
      - SINGLE_REGISTRY=true
      # UI é¡¯ç¤ºçš„æ¨™é¡Œ
      - REGISTRY_TITLE=Amanda Registry
      # å…è¨±å¾ UI åˆªé™¤ imageï¼ˆéœ€å¾Œç«¯å•Ÿç”¨ DELETEï¼‰
      - DELETE_IMAGES=true
      # é¡¯ç¤º digestï¼ˆæœ‰åŠ©æ–¼è­˜åˆ¥ image å±¤ï¼‰
      - SHOW_CONTENT_DIGEST=true
      # å¾Œç«¯ registry æœå‹™çš„ä½å€ï¼ˆèˆ‡ä¸‹æ–¹ registry-server å°æ‡‰ï¼‰
      - NGINX_PROXY_PASS_URL=http://localhost:30500
      # é¡¯ç¤ºæ¯å€‹ repository çš„ tag æ•¸é‡
      - SHOW_CATALOG_NB_TAGS=true
      # æ¯é é¡¯ç¤ºçš„ branch/tag æ•¸ï¼ˆé™åˆ¶é¡¯ç¤ºæ•¸é‡ï¼‰
      - CATALOG_MIN_BRANCHES=1
      - CATALOG_MAX_BRANCHES=1
      # æ¯é é¡¯ç¤º tag æ•¸é‡
      - TAGLIST_PAGE_SIZE=100
      # æ˜¯å¦å•Ÿç”¨ HTTPSï¼ˆè‹¥ç‚º false è¡¨ç¤ºä½¿ç”¨ httpï¼‰
      - REGISTRY_SECURED=false
      # Catalog é é¢é¡¯ç¤ºæœ€å¤§ repository æ•¸
      - CATALOG_ELEMENTS_LIMIT=1000

      # ğŸ”¹ï¼ˆå¯é¸ï¼‰é€²éšè¨­å®šï¼š
      # - DELETE_IMAGES_CONFIRMATION=true      # å•Ÿç”¨åˆªé™¤å‰äºŒæ¬¡ç¢ºèª
      # - REGISTRY_URL=http://registry-server:5000 # æ˜ç¢ºæŒ‡å®š registry URL
      # - PULL_URL=http://registry-server:5000      # ç”¨æ–¼ pull image çš„é€£çµ
      # - SHOW_CATALOG_LAST_UPDATE=true             # é¡¯ç¤ºæœ€å¾Œæ›´æ–°æ™‚é–“
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf

    logging:
      driver: "json-file"
      options:
        max-size: "10M"
    deploy:
      resources:
        limits:
          # cpus: "1"
          memory: 512M

  # -----------------------------------------
  # Docker Registryï¼ˆæ ¸å¿ƒç§æœ‰å€‰åº«æœå‹™ï¼‰
  # -----------------------------------------
  registry-server:
    image: registry:3.0.0 # Docker å®˜æ–¹ registryï¼ˆå»ºè­°å›ºå®šç‰ˆè™Ÿ 2.8.3ï¼‰
    container_name: registry-server
    restart: always
    network_mode: host
    environment:
      # CORS è¨­å®šï¼Œå…è¨± UI ç¶²åŸŸå­˜å–
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: "[http://docker.example.com]"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: "[HEAD,GET,OPTIONS,DELETE]"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Credentials: "[true]"
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Headers: "[Authorization,Accept,Cache-Control]"
      REGISTRY_HTTP_HEADERS_Access-Control-Expose-Headers: "[Docker-Content-Digest]"

      # å•Ÿç”¨ image åˆªé™¤åŠŸèƒ½
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
      REGISTRY_HTTP_SECRET: "aa3f010228631c7a188ac28fd2c3622ed42ff9ce58444eaf00aa659700fef598"

      # ğŸ”¹ï¼ˆå¯é¸ï¼‰é€²éšè¨­å®šï¼š
      REGISTRY_HTTP_ADDR: "0.0.0.0:30500" # æ˜ç¢ºæŒ‡å®šç›£è½ port
      # REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      REGISTRY_STORAGE_CACHE_BLOBDESCRIPTOR: inmemory # å•Ÿç”¨è¨˜æ†¶é«”å¿«å–
      # REGISTRY_STORAGE_MAINTENANCE_UPLOADPURGING_ENABLED: "false"
      # REGISTRY_LOG_LEVEL: info                    # å¯é¸ debug/info/warn/error
      REGISTRY_HTTP_DEBUG_ADDR: ""
      REGISTRY_OTEL_ENABLED: "false"
      REGISTRY_OTEL_TRACES_EXPORTER: "none"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://localhost:30500"
      OTEL_EXPORTER_OTLP_TRACES_ENDPOINT: "http://localhost:30500"
      # REGISTRY_HTTP_HEADERS_X-Content-Type-Options: "[nosniff]"

      # è‹¥æœªä¾†éœ€è¦å•Ÿç”¨ Basic Authï¼Œå¯æ–°å¢ï¼š
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: "Amanda Registry Realm"
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      # ä¸¦æ›è¼‰ volume: ./auth:/auth
      # ç”¢ç”Ÿå¯†ç¢¼æª”
      # mkdir auth
      # docker run --rm --entrypoint htpasswd httpd:2 -Bbn admin MySecret > auth/htpasswd

    volumes:
      - ./registry/data:/var/lib/registry # æŒä¹…åŒ–å„²å­˜ image å±¤
      - ./auth:/auth # è‹¥å•Ÿç”¨ç™»å…¥é©—è­‰ï¼Œéœ€æ­¤æ›è¼‰
    logging:
      driver: "json-file"
      options:
        max-size: "10M"
    deploy:
      resources:
        limits:
          # cpus: "2"
          memory: 2G
