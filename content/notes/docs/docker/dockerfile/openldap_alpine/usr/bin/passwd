#!/bin/bash

set -e
GREEN='\033[1;32m'
RED='\033[0;31m'
RESET='\033[0m'
LOG='/tmp/temp'
M=$((${RANDOM} % 3))

replace_DN() {
  domain=($(echo ${LDAP_DOMAIN} | sed 's/\./ /g'))
  LDAP_DC=${domain[$(( ${#domain[@]} - 2  ))]}

  LDAP_DOMAIN=''
  for (( i=0 ; i < ${#domain[@]} ; i++  ))
  do
    LDAP_DOMAIN="${LDAP_DOMAIN}dc=${domain[$i]},"
  done
  LDAP_DOMAIN=$(echo ${LDAP_DOMAIN} | sed 's/,$//')
}

search_person() {
  user=$1
  USER_DN=$(ldapsearch -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} -b "${LDAP_DOMAIN}" "uid=${user}" | grep "dn" | awk '{print $2}')
  if [[ "${USER_DN}" == "" ]];then
    echo -e "There is no ${GREEN}${user}${RESET}"
    echo "There is no ${user}" >> ${LOG}
    exit 0
  fi
}

change_pass() {
  replace_DN
  search_person $1
  P1=$((${RANDOM} % 4 + 1 + ${M}))
  P2=$((${RANDOM} % 4 + 11 + ${M}))
  P3=$((${RANDOM} % 4 + 17 + ${M}))
  NEW_PW=$(head -c 22 /dev/random | base64 | sed "s/./&@/${P1};s/./&!/${P2};s/./&,/${P3}")
  date "+%F %T.%3N" >> ${LOG}
  echo "${USER_DN}" >> ${LOG}
  echo "${NEW_PW}" >> ${LOG}
  echo "" >> ${LOG}
  ldappasswd -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} "${USER_DN}" -s "${NEW_PW}"
  echo -e "${RED}$(date)${RESET}"
  echo -e "${USER_DN} ... [${GREEN}Done${RESET}]"
}

verify() {
VERIFY='/opt/temp'
date '+%F %T.%3N' >> ${VERIFY}
echo 'Verify before change.' >> ${VERIFY}
read -p 'Please enter svn username: ' user
echo "user: ${user}" >> ${VERIFY}
printf 'Please enter svn password: '
read -s pass
echo ''
echo "pass: ${pass}" >> ${VERIFY}
read -p 'Please confirm to continue...(yes/no) ' ans
echo "execute: ${ans}" >> ${VERIFY}
if [[ "${ans}" != "yes" ]] || [[ "${ans}" != "y" ]];then
  echo 'Exit the program.'
  echo 'Exit the program.' >> ${VERIFY}
  echo 'Exit the program.' >> ${LOG}
  echo '' >> ${VERIFY}
  echo '' >> ${LOG}
  exit 0
fi
}

search_all() {
  ALL_DN=$(ldapsearch -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} -b "${LDAP_DOMAIN}" "objectClass=inetOrgPerson" | grep "dn" | awk '{print $2}')
}

change_all_pass() {
  replace_DN
  search_all
  date "+%F %T.%3N" >> ${LOG}
  verify
  for p in ${ALL_DN}
  do
    P1=$((${RANDOM} % 4 + 2 + ${M}))
    P2=$((${RANDOM} % 4 + 13 + ${M}))
    P3=$((${RANDOM} % 4 + 19 + ${M}))
    NEW_PW=$(head -c 27 /dev/random | base64 | sed "s/./&@/${P1};s/./&!/${P2};s/./&,/${P3}")
    echo "${p}" >> ${LOG}
    echo "${NEW_PW}" >> ${LOG}
    echo "" >> ${LOG}
    ldappasswd -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} "${p}" -s "${NEW_PW}"
    echo -e "${p} ... [${GREEN}Done${RESET}]"
  done
}

case $1 in
  -a|--all|auto)
    change_all_pass
  ;;
  -c|--change|change)
    change_pass $2
  ;;
  *)
    echo "Usage: $0 [OPTION]"
    echo "Usage: $0 -a"
    echo "Usage: $0 -c uid"
    echo "OPTION:"
    echo "  -a  change all password"
    echo "  -c  change password for specific person"
    exit 1
  ;;
esac
