#!/bin/bash

set -e
DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" &>/dev/null && pwd -P)
M=$((${RANDOM} % 3))

setup_colors() {
if [[ -t 2 ]] && [[ -z "${NO_COLOR-}" ]] && [[ "${TERM-}" != "dumb" ]]; then
  RESET='\033[0m' RED='\033[0;31m' GREEN='\033[0;32m' ORANGE='\033[0;33m' BLUE='\033[0;34m' PURPLE='\033[0;35m' CYAN='\033[0;36m' YELLOW='\033[1;33m'
else
  RESET='' RED='' GREEN='' ORANGE='' BLUE='' PURPLE='' CYAN='' YELLOW=''
fi
}

logg() {
LOG='/tmp/temp'
echo "${1-}" >> ${LOG}
}

msg() {
  echo >&2 -e "${1-}"
}

replace_DN() {
  domain=($(echo ${LDAP_DOMAIN} | sed 's/\./ /g'))
  LDAP_DC=${domain[$(( ${#domain[@]} - 2  ))]}

  LDAP_DOMAIN=''
  for (( i=0 ; i < ${#domain[@]} ; i++  ))
  do
    LDAP_DOMAIN="${LDAP_DOMAIN}dc=${domain[$i]},"
  done
  LDAP_DOMAIN=$(echo ${LDAP_DOMAIN} | sed 's/,$//')
}

search_person() {
  user=$1
  USER_DN=$(ldapsearch -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} -b "${LDAP_DOMAIN}" "uid=${user}" | grep "dn" | awk '{print $2}')
  if [[ "${USER_DN}" == "" ]];then
    msg "There is no ${GREEN}${user}${RESET}"
    logg "$(date '+%F %T.%3N')"
    logg "There is no ${user}"
    logg ''
    exit 0
  fi
}

change_pass() {
  replace_DN
  search_person $1
  P1=$((${RANDOM} % 4 + 1 + ${M}))
  P2=$((${RANDOM} % 4 + 11 + ${M}))
  P3=$((${RANDOM} % 4 + 17 + ${M}))
  NEW_PW=$(head -c 22 /dev/random | base64 | sed "s/./&@/${P1};s/./&!/${P2};s/./&,/${P3}")
  logg "$(date '+%F %T.%3N')"
  logg "${USER_DN}"
  logg "${NEW_PW}"
  logg ''
  ldappasswd -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} "${USER_DN}" -s "${NEW_PW}"
  msg "${RED}$(date)${RESET}"
  msg "${USER_DN} ... [${GREEN}Done${RESET}]"
}

verify() {
  logv() {
    VERIFY='/opt/temp'
    echo "${1-}" >> ${VERIFY}
  }
logv "$(date '+%F %T.%3N')"
logv 'Verify before change.'
read -p 'Please enter svn username: ' user
logv "user: ${user}"
printf 'Please enter svn password: '
read -s pass
msg ''
logv "pass: ${pass}"
read -p 'Please confirm to continue...(yes/no) ' ans
logv "execute: ${ans}"
if [[ "${ans}" != "yes" ]] && [[ "${ans}" != "y" ]];then
  msg 'Exit the program.'
  logv 'Exit the program.'
  logg 'Exit the program.'
  logv ''
  logg ''
  exit 0
fi
}

search_all() {
  ALL_DN=$(ldapsearch -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} -b "${LDAP_DOMAIN}" "objectClass=inetOrgPerson" | grep "dn" | awk '{print $2}')
}

change_all_pass() {
  replace_DN
  search_all
  logg "$(date '+%F %T.%3N')"
  verify
  for p in ${ALL_DN}
  do
    P1=$((${RANDOM} % 4 + 2 + ${M}))
    P2=$((${RANDOM} % 4 + 13 + ${M}))
    P3=$((${RANDOM} % 4 + 19 + ${M}))
    NEW_PW=$(head -c 27 /dev/random | base64 | sed "s/./&@/${P1};s/./&!/${P2};s/./&,/${P3}")
    logg "${p}"
    logg "${NEW_PW}"
    logg ""
    ldappasswd -x -D "cn=admin,${LDAP_DOMAIN}" -w ${LDAP_ADMIN_PASS} "${p}" -s "${NEW_PW}"
    msg "${p} ... [${GREEN}Done${RESET}]"
  done
}

usage() {
  cat <<EOF
Usage: $(basename "${BASH_SOURCE[0]}") [OPTION]
Usage: $(basename "${BASH_SOURCE[0]}") -a
Usage: $(basename "${BASH_SOURCE[0]}") -c uid
OPTION:
  -a  change all password
  -c  change password for specific person
EOF
  exit 1
}

setup_colors

case $1 in
  -a|--all|auto)
    change_all_pass
  ;;
  -c|--change|change)
    change_pass $2
  ;;
  *)
    usage
  ;;
esac
